#!/bin/sh

KERNEL_CONFIG=./.config

if [[ ! -f "${KERNEL_CONFIG}" ]]; then
	echo "Current working directory needs to be the one with a kernel sources!" >&2
	exit 1
fi

## check if root is mounted from LVM/Luks/etc.
ROOT_DEV_FILE=`grep '^[^ ]*\s/\s' /proc/mounts | tail -1 | sed 's|^[^ ]*/\([^/ ]*\) .*$|\1|'`
OPTS="$@ all"
dmsetup status | grep -q "^${ROOT_DEV_FILE}:.*\\scrypt\\s" && OPTS="--luks ${OPTS}" || OPTS="--no-luks ${OPTS}"
grep -q "^[^ ]*${ROOT_DEV_FILE}\\s/\\sbtrfs\\s" /proc/mounts && OPTS="--btrfs ${OPTS}" || OPTS="--no-btrfs ${OPTS}"
lvdisplay "/dev/mapper/${ROOT_DEV_FILE}" 2>/dev/null 1>&2 && OPTS="--lvm ${OPTS}" || OPTS="--no-lvm ${OPTS}"

## extra modules
MODULES_EXTRA="serio i8042 atkbd" \
exec genkernel "--kernel-config=${KERNEL_CONFIG}" ${OPTS}
